{% extends 'base.html' %}

{% block title %}Mi Perfil - Farmacias La Guadalajara{% endblock %}
{% block header_title %}Mi Perfil{% endblock %}
{% block header_subtitle %}Gestiona tu cuenta y preferencias{% endblock %}

{% block content %}
<div class="row">
    <!-- Sidebar de navegación -->
    <div class="col-lg-3 mb-4">
        <div class="card">
            <div class="card-body text-center">
                <div class="mb-3">
                    <div class="avatar-placeholder bg-primary text-white rounded-circle d-inline-flex align-items-center justify-content-center" 
                         style="width: 80px; height: 80px; font-size: 2rem;">
                        <i class="bi bi-person-fill"></i>
                    </div>
                </div>
                <h5 class="card-title">
                    {% if user and user.nombre and user.apellido %}
                        {{ user.nombre }} {{ user.apellido }}
                    {% elif user and user.email %}
                        {{ user.email }}
                    {% else %}
                        Usuario
                    {% endif %}
                </h5>
                <p class="card-text small text-muted">
                    Miembro desde: {{ user.created_at.strftime('%d/%m/%Y') if user and user.created_at else 'Fecha no disponible' }}
                </p>
                <span class="badge bg-success">
                    <i class="bi bi-patch-check me-1"></i>
                    Cuenta verificada
                </span>
            </div>
            <div class="list-group list-group-flush">
                <a href="#info-personal" class="list-group-item list-group-item-action active">
                    <i class="bi bi-person me-2"></i>Información Personal
                </a>
                <a href="#historial-pedidos" class="list-group-item list-group-item-action">
                    <i class="bi bi-receipt me-2"></i>Pedidos Recientes
                </a>
                <a href="{{ url_for('order_history') }}" class="list-group-item list-group-item-action">
                    <i class="bi bi-clock-history me-2"></i>Historial de Compras
                </a>
                <a href="{{ url_for('my_prescriptions') }}" class="list-group-item list-group-item-action">
                    <i class="bi bi-file-earmark-medical me-2"></i>Mis Recetas
                </a>
                <a href="{{ url_for('my_addresses') }}" class="list-group-item list-group-item-action">
                    <i class="bi bi-geo-alt me-2"></i>Direcciones
                </a>
                <a href="{{ url_for('notification_settings') }}" class="list-group-item list-group-item-action">
                    <i class="bi bi-bell me-2"></i>Notificaciones
                </a>
                <a href="{{ url_for('change_password') }}" class="list-group-item list-group-item-action">
                    <i class="bi bi-shield-lock me-2"></i>Seguridad
                </a>
                <a href="{{ url_for('logout') }}" class="list-group-item list-group-item-action text-danger">
                    <i class="bi bi-box-arrow-right me-2"></i>Cerrar Sesión
                </a>
            </div>
        </div>

        <!-- Tarjeta de puntos o beneficios -->
        <div class="card mt-4 bg-gradient-primary text-white">
            <div class="card-body text-center">
                <i class="bi bi-award display-6 mb-3"></i>
                <h6>Programa de Fidelidad</h6>
                <h3 class="mb-2">1,250 pts</h3>
                <p class="small opacity-75 mb-3">Acumula puntos en cada compra</p>
                <div class="progress mb-2" style="height: 6px;">
                    <div class="progress-bar bg-warning" style="width: 65%"></div>
                </div>
                <small class="opacity-75">65% hacia tu próximo beneficio</small>
            </div>
        </div>

        <!-- Acciones rápidas -->
        <div class="card mt-4">
            <div class="card-header bg-light">
                <h6 class="mb-0">Acciones Rápidas</h6>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <a href="{{ url_for('index') }}" class="btn btn-outline-primary btn-sm">
                        <i class="bi bi-bag me-1"></i>Seguir Comprando
                    </a>
                    <a href="{{ url_for('upload_prescription') }}" class="btn btn-outline-success btn-sm">
                        <i class="bi bi-cloud-upload me-1"></i>Subir Receta
                    </a>
                    {% if orders and orders|length > 0 %}
                    <a href="{{ url_for('order_history') }}" class="btn btn-outline-info btn-sm">
                        <i class="bi bi-list-check me-1"></i>Ver Todos los Pedidos
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Contenido principal -->
    <div class="col-lg-9">
        <!-- Información personal -->
        <div id="info-personal" class="card mb-4">
            <div class="card-header bg-light d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="bi bi-person me-2"></i>Información Personal
                </h5>
                <a href="{{ url_for('edit_profile') }}" class="btn btn-outline-primary btn-sm">
                    <i class="bi bi-pencil me-1"></i>Editar
                </a>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <table class="table table-borderless">
                            <tr>
                                <th width="40%" class="text-muted">Nombre completo:</th>
                                <td>
                                    {% if user and user.nombre and user.apellido %}
                                        {{ user.nombre }} {{ user.apellido }}
                                    {% elif user %}
                                        <span class="text-muted">No especificado</span>
                                    {% else %}
                                        <span class="text-muted">Usuario no disponible</span>
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <th class="text-muted">Correo electrónico:</th>
                                <td>{{ user.email if user and user.email else 'No disponible' }}</td>
                            </tr>
                            <tr>
                                <th class="text-muted">Teléfono:</th>
                                <td>
                                    {% if user and user.telefono %}
                                        {{ user.telefono }}
                                    {% else %}
                                        <span class="text-muted">No especificado</span>
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <th class="text-muted">Fecha de nacimiento:</th>
                                <td>
                                    {% if user and user.fecha_nacimiento %}
                                        {{ user.fecha_nacimiento }}
                                    {% else %}
                                        <span class="text-muted">No especificada</span>
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <th class="text-muted">Género:</th>
                                <td>
                                    {% if user and user.genero %}
                                        {{ user.genero|title }}
                                    {% else %}
                                        <span class="text-muted">No especificado</span>
                                    {% endif %}
                                </td>
                            </tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        {% if user and user.direccion and user.direccion.calle %}
                        <div class="card bg-light">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i class="bi bi-geo-alt me-2"></i>Dirección Principal
                                </h6>
                            </div>
                            <div class="card-body">
                                <p class="small mb-1">
                                    {{ user.direccion.calle }} 
                                    {{ user.direccion.numero_exterior }}
                                    {% if user.direccion.numero_interior %}
                                        Int. {{ user.direccion.numero_interior }}
                                    {% endif %}
                                </p>
                                <p class="small mb-1">
                                    {{ user.direccion.colonia }}, 
                                    {{ user.direccion.codigo_postal }}
                                </p>
                                <p class="small mb-1">
                                    {{ user.direccion.ciudad }}, {{ user.direccion.estado }}
                                </p>
                                {% if user.direccion.referencias %}
                                <p class="small text-muted mt-2 mb-0">
                                    <strong>Referencias:</strong> {{ user.direccion.referencias }}
                                </p>
                                {% endif %}
                            </div>
                        </div>
                        {% else %}
                        <div class="card bg-light">
                            <div class="card-body text-center">
                                <i class="bi bi-geo-alt text-muted display-6 mb-3"></i>
                                <h6 class="text-muted">Sin dirección guardada</h6>
                                <p class="small text-muted mb-3">
                                    Agrega una dirección para envíos más rápidos
                                </p>
                                <a href="{{ url_for('edit_profile') }}" class="btn btn-outline-primary btn-sm">
                                    <i class="bi bi-plus me-1"></i>Agregar Dirección
                                </a>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Resumen rápido CORREGIDO -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <i class="bi bi-receipt text-primary display-6 mb-3"></i>
                        <h4 class="text-primary">
                            {% if orders is defined and orders %}
                                {{ orders|length }}
                            {% else %}
                                0
                            {% endif %}
                        </h4>
                        <p class="text-muted mb-0">Pedidos Recientes</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <i class="bi bi-file-medical text-success display-6 mb-3"></i>
                        <h4 class="text-success">
                            {% if prescriptions is defined and prescriptions %}
                                {{ prescriptions|length }}
                            {% else %}
                                0
                            {% endif %}
                        </h4>
                        <p class="text-muted mb-0">Recetas Subidas</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <i class="bi bi-cart-check text-warning display-6 mb-3"></i>
                        <h4 class="text-warning">
                            {% if orders is defined and orders %}
                                {% set pending_count = 0 %}
                                {% for order in orders %}
                                    {% if order.status == 'pendiente' %}
                                        {% set pending_count = pending_count + 1 %}
                                    {% endif %}
                                {% endfor %}
                                {{ pending_count }}
                            {% else %}
                                0
                            {% endif %}
                        </h4>
                        <p class="text-muted mb-0">Pedidos Pendientes</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <i class="bi bi-clock-history text-info display-6 mb-3"></i>
                        <h4 class="text-info">
                            {% if orders is defined and orders %}
                                {% set total_orders = orders|length %}
                            {% else %}
                                0
                            {% endif %}
                        </h4>
                        <p class="text-muted mb-0">Total Compras</p>
                        <a href="{{ url_for('order_history') }}" class="btn btn-link btn-sm p-0 mt-1">
                            Ver historial completo
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Historial de pedidos recientes CORREGIDO -->
        <div id="historial-pedidos" class="card">
            <div class="card-header bg-light d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="bi bi-receipt me-2"></i>Pedidos Recientes
                </h5>
                <div>
                    <a href="{{ url_for('order_history') }}" class="btn btn-outline-primary btn-sm">
                        <i class="bi bi-clock-history me-1"></i>Ver Historial Completo
                    </a>
                </div>
            </div>
            <div class="card-body">
                {% if orders is defined and orders and orders|length > 0 %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th># Orden</th>
                                <th>Fecha</th>
                                <th>Productos</th>
                                <th>Total</th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for order in orders %}
                            <tr>
                                <td>
                                    <small class="text-muted">#{{ order._id|string|truncate(8, True, '') }}</small>
                                </td>
                                <td>
                                    <small>{{ order.created_at.strftime('%d/%m/%Y') if order.created_at else 'N/A' }}</small>
                                </td>
                                <td>
                                    <small>
                                        {% if order.items and order.items is iterable and order.items is not string %}
                                            {{ order.items|length }} producto(s)
                                        {% elif order.items %}
                                            1 producto
                                        {% else %}
                                            0 productos
                                        {% endif %}
                                    </small>
                                </td>
                                <td>
                                    <strong>${{ "%.2f"|format(order.total) if order.total else '0.00' }}</strong>
                                </td>
                                <td>
                                    {% if order.status == 'completado' %}
                                        <span class="badge bg-success">{{ order.status|title }}</span>
                                    {% elif order.status == 'pendiente' %}
                                        <span class="badge bg-warning">{{ order.status|title }}</span>
                                    {% elif order.status == 'cancelado' %}
                                        <span class="badge bg-danger">{{ order.status|title }}</span>
                                    {% else %}
                                        <span class="badge bg-secondary">{{ order.status|default('pendiente')|title }}</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <a href="{{ url_for('order_detail', order_id=order._id) }}" 
                                           class="btn btn-outline-primary">
                                            <i class="bi bi-eye"></i>
                                        </a>
                                        {% if order.status == 'completado' %}
                                        <form action="{{ url_for('reorder', order_id=order._id) }}" method="post" class="d-inline">
                                            <button type="submit" class="btn btn-outline-success">
                                                <i class="bi bi-arrow-repeat"></i>
                                            </button>
                                        </form>
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                {% if orders|length >= 5 %}
                <div class="text-center mt-3">
                    <p class="text-muted small mb-2">
                        Mostrando los 5 pedidos más recientes
                    </p>
                    <a href="{{ url_for('order_history') }}" class="btn btn-primary btn-sm">
                        <i class="bi bi-clock-history me-1"></i>Ver Todos los Pedidos
                    </a>
                </div>
                {% endif %}
                
                {% else %}
                <div class="text-center py-4">
                    <i class="bi bi-cart display-1 text-muted mb-3"></i>
                    <h5 class="text-muted">No hay pedidos registrados</h5>
                    <p class="text-muted mb-4">Realiza tu primera compra para ver tu historial aquí.</p>
                    <div class="d-grid gap-2 d-md-block">
                        <a href="{{ url_for('index') }}" class="btn btn-primary">
                            <i class="bi bi-bag me-1"></i>Ir de Compras
                        </a>
                        <a href="{{ url_for('order_history') }}" class="btn btn-outline-secondary">
                            <i class="bi bi-clock-history me-1"></i>Ver Historial
                        </a>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Sección de recetas recientes -->
        {% if prescriptions is defined and prescriptions and prescriptions|length > 0 %}
        <div class="card mt-4">
            <div class="card-header bg-light d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="bi bi-file-earmark-medical me-2"></i>Recetas Recientes
                </h5>
                <a href="{{ url_for('my_prescriptions') }}" class="btn btn-outline-primary btn-sm">
                    <i class="bi bi-list-ul me-1"></i>Ver Todas
                </a>
            </div>
            <div class="card-body">
                <div class="row">
                    {% for prescription in prescriptions[:3] %}
                    <div class="col-md-4 mb-3">
                        <div class="card border">
                            <div class="card-body text-center">
                                <i class="bi bi-file-earmark-pdf text-danger display-6 mb-2"></i>
                                <h6 class="card-title">{{ prescription.original_filename or prescription.filename }}</h6>
                                <p class="card-text small text-muted">
                                    {{ prescription.uploaded_at.strftime('%d/%m/%Y') if prescription.uploaded_at else 'N/A' }}
                                </p>
                                <span class="badge bg-{{ 'success' if prescription.status == 'approved' else 'warning' if prescription.status == 'pending' else 'danger' }}">
                                    {{ prescription.status|title }}
                                </span>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% if prescriptions|length > 3 %}
                <div class="text-center mt-3">
                    <a href="{{ url_for('my_prescriptions') }}" class="btn btn-outline-primary btn-sm">
                        Ver todas las recetas ({{ prescriptions|length }})
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}

        <!-- Información de contacto rápida -->
        <div class="row mt-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body text-center">
                        <i class="bi bi-headset text-primary display-4 mb-3"></i>
                        <h6>Soporte 24/7</h6>
                        <p class="small text-muted mb-2">
                            ¿Necesitas ayuda con tus pedidos?
                        </p>
                        <div class="small text-muted">
                            <i class="bi bi-telephone me-1"></i>33 1234 5678<br>
                            <i class="bi bi-envelope me-1"></i>soporte@farmaciasguadalajara.com
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body text-center">
                        <i class="bi bi-truck text-success display-4 mb-3"></i>
                        <h6>Envío Rápido</h6>
                        <p class="small text-muted mb-2">
                            Recibe tus productos en 24-48 horas
                        </p>
                        <div class="small text-muted">
                            <i class="bi bi-geo-alt me-1"></i>Toda Guadalajara<br>
                            <i class="bi bi-clock me-1"></i>Lunes a Domingo
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Animaciones simples para las tarjetas
    const cards = document.querySelectorAll('.card');
    cards.forEach(card => {
        card.style.transition = 'transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out';
        card.addEventListener('mouseenter', function() {
            this.style.transform = 'translateY(-2px)';
            this.style.boxShadow = '0 4px 15px rgba(0,0,0,0.1)';
        });
        card.addEventListener('mouseleave', function() {
            this.style.transform = 'translateY(0)';
            this.style.boxShadow = '';
        });
    });

    // Tooltips para botones
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    const tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
});
</script>
{% endblock %} 